--- MAUDE_HCS: maude_hcs
---
--- Software Markings (UNCLASS)
--- PWNDD Software
---
--- Copyright (C) 2025 RTX BBN Technologies Inc. All Rights Reserved
---
--- Contract No: HR00112590083
--- Contractor Name: RTX BBN Technologies Inc.
--- Contractor Address: 10 Moulton Street, Cambridge, Massachusetts 02138
---
--- The U.S. Government's rights to use, modify, reproduce, release, perform,
--- display, or disclose these technical data and software are defined in the
--- Article VII: Data Rights clause of the OTA.
---
--- This document does not contain technology or technical data controlled under
--- either the U.S. International Traffic in Arms Regulations or the U.S. Export
--- Administration Regulations.
---
--- DISTRIBUTION STATEMENT A: Approved for public release; distribution is
--- unlimited.
---
--- Notice: Markings. Any reproduction of this computer software, computer
--- software documentation, or portions thereof must also reproduce the markings
--- contained herein.
---
--- MAUDE_HCS: end

sload ../common/_aux
sload ../../../common/maude/cp2-interfaces

mod MASAUX is
  inc MASTODON_NODE .
  inc MC-INTERFACE .

  --- Get a post by Mastodon Id.
  op GetPost : MasId -> Content .
  --- Get all media from toots with a hashtag.
****  op GetMediaHashtag : Tag -> Content .
  --- Get all media from toots with a hashtag, limit number of toots back.
****  op GetMediaHashtag : Tag Nat -> Content .
  --- Get media at URL.
  op GetMedia : Url -> Content .
  --- Refresh timeline (generated content).
  op GetTimeline : -> Content .
  --- Post media file.
  op PostMedia : MediaFile -> Content .
  --- Post status (toot text).
  op PostStatus : String -> Content .
  --- Post status (toot text) with media attachments.
****  op PostStatus : String MediaFileList -> Content .

  --- Dispatch the proper request depending on the Raceboat client command.
  op dispatchRaceboatCommand : AttributeSet Content -> AttributeSetMsgs .
  ceq dispatchRaceboatCommand(attrs:AttributeSet, raceboatReq:Content) =
    uploadNewStatus(attrs:AttributeSet, TEXT:String, emptyMasIdList)
    if PostStatus(TEXT:String) := raceboatReq:Content
    .
  ceq dispatchRaceboatCommand(attrs:AttributeSet, raceboatReq:Content) =
    uploadNewMedia(attrs:AttributeSet, MEDIA:MediaFile)
    if PostMedia(MEDIA:MediaFile) := raceboatReq:Content
    .
  ceq dispatchRaceboatCommand(attrs:AttributeSet, raceboatReq:Content) =
    uploadNewStatusWImages(attrs:AttributeSet, TEXT:String, MEDIA_LIST:MediaFileList)
    if PostStatus(TEXT:String, MEDIA_LIST:MediaFileList) := raceboatReq:Content
    .
  ceq dispatchRaceboatCommand(attrs:AttributeSet, raceboatReq:Content) =
    downloadPost(attrs:AttributeSet, POST_ID:MasId)
    if GetPost(POST_ID:MasId) := raceboatReq:Content
    .
  ceq dispatchRaceboatCommand(attrs:AttributeSet, raceboatReq:Content) =
    downloadMediaAtHashtag(attrs:AttributeSet, TAG:Tag)
    if GetMediaHashtag(TAG:Tag) := raceboatReq:Content
    .
  ceq dispatchRaceboatCommand(attrs:AttributeSet, raceboatReq:Content) =
    downloadMediaAtHashtag(attrs:AttributeSet, TAG:Tag, N:Nat)
    if GetMediaHashtag(TAG:Tag, N:Nat) := raceboatReq:Content
    .
  ceq dispatchRaceboatCommand(attrs:AttributeSet, raceboatReq:Content) =
    downloadMediaAtUrl(attrs:AttributeSet, URL:Url)
    if GetMedia(URL:Url) := raceboatReq:Content
    .
  ceq dispatchRaceboatCommand(attrs:AttributeSet, raceboatReq:Content) =
    downloadTimeline(attrs:AttributeSet)
    if GetTimeline := raceboatReq:Content
    .
  eq dispatchRaceboatCommand(attrs:AttributeSet, raceboatReq:Content) =
    dispatchRaceboatCommand(attrs:AttributeSet, translateRbToMasCommand(raceboatReq:Content))
    [owise]
    .

  op translateRbToMasCommand : Content -> Content .
  --- Translate tootQ(hashtag).
  ceq translateRbToMasCommand(requesterReq:Content) =
    PostStatus(text:String) 
    if tootQ(HASHTAG:ByteSeq, noBytes) := requesterReq:Content
      /\ text:String := "#" + getHashtag(HASHTAG:ByteSeq)
    [print "Translating requester req " requesterReq:Content " to Mastodon command post " text:String "." ]
    .
  --- Translate tootQ(hashtag, image).
  ceq translateRbToMasCommand(requesterReq:Content) =
    PostStatus(text:String, mediaFileList:MediaFileList)
    if tootQ(HASHTAG:ByteSeq, image:ByteSeq) := requesterReq:Content
      /\ text:String := "#" + getHashtag(HASHTAG:ByteSeq)
      /\ filename:String := getFilename(image:ByteSeq)
      /\ mediaFileList:MediaFileList := makeMediaFile(filename:String,
                                                      getSize(image:ByteSeq),
                                                      image:ByteSeq)
    [print "Translating requester req " requesterReq:Content " to Mastodon command post " text:String " with media " mediaFileList:MediaFileList ]
    .

endm

eof

---set trace on .
red translateRbToMasCommand(tootQ(bHashTag(4), noBytes))
  == PostStatus("#4")
  .

red dispatchRaceboatCommand(attrs:AttributeSet, tootQ(bHashTag(4), noBytes))
  == uploadNewStatus(attrs:AttributeSet, "#4", emptyMasIdList)
  .

<<<<<<< HEAD
red translateRbToMasCommand(tootQ(wHashTag(4), image(4, 100, 400)))
  == PostStatus("#4", makeMediaFile("img_4.jpg", 400, image(4, 100, 400)))
  .



